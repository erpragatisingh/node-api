'use strict'

const mssql = require('./')
const wtf = require('wtfnode');

const sqlConfig = {
  password: '&r8wrucH',
  database: 'StockDB',
  stream: false,
  options: {
    // trustServerCertificate: true,
    enableArithAbort: true,
    encrypt: true,
    abortTransactionOnError: false,
  },
  pool: {
    max: 1,
    min: 0,
  },
  port: 1433,
  user: 'dhensby',
  server: '4sa.database.windows.net',
}

// Bad URI, connection timeouts, hangs process
mssql.connect({ ...sqlConfig, port: 2345 }).catch(err => {
  console.error(err.message);
  console.log('reconnecting...');

  // Try to connect using the right URI
  return mssql
    .connect(sqlConfig)
    .then(() => console.log('connected'))
    .then(() => mssql.close())
    .then(() => console.log('closed'))
    .catch(err => {
      console.error(err.message)
      wtf.dump()
    });  // <-- Fails here
});
